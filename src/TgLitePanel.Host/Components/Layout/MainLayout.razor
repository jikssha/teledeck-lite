@inherits LayoutComponentBase
@implements IDisposable
@inject ITdClientManager TdClientManager
@inject AppUpdateService AppUpdate
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject IAppConfigService AppConfigService
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime Js
@inject ISnackbar Snackbar
@using TgLitePanel.Host.Services

<MudThemeProvider IsDarkMode="@_isDarkMode" Theme="@_theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    @* 顶部栏 - 毛玻璃效果 *@
    <MudAppBar Elevation="0" Class="teledeck-appbar">
        <MudIconButton Icon="@Icons.Material.Filled.Menu"
                       Color="Color.Inherit"
                       Edge="Edge.Start"
                       OnClick="@ToggleDrawer"
                       aria-label="打开侧边栏菜单" />

        <div class="d-flex align-center">
            <MudIcon Icon="@Icons.Custom.Brands.Telegram" Size="Size.Medium" Class="me-2" Style="color: var(--mud-palette-primary);" />
            <MudText Typo="Typo.h6" Class="teledeck-title">Teledeck</MudText>
        </div>

        <MudSpacer />

        @* 全局搜索 *@
        <MudTooltip Text="全局搜索（开发中）">
            <MudIconButton Icon="@Icons.Material.Filled.Search"
                           Color="Color.Inherit"
                           title="全局搜索"
                           OnClick="@ShowSearchNotReady"
                           aria-label="全局搜索" />
        </MudTooltip>

        @* 明暗主题切换 *@
        <MudTooltip Text="@(_isDarkMode ? "切换到浅色模式" : "切换到深色模式")">
            <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                           Color="Color.Inherit"
                           title="@(_isDarkMode ? "切换到浅色模式" : "切换到深色模式")"
                           OnClick="@ToggleThemeAsync"
                           aria-label="@(_isDarkMode ? "切换到浅色模式" : "切换到深色模式")" />
        </MudTooltip>

        @* GitHub 与版本信息 *@
        <MudTooltip Text="在新标签页打开 GitHub 仓库">
            <MudIconButton Icon="@AppIcons.GitHub"
                           Color="Color.Inherit"
                           Disabled="@string.IsNullOrWhiteSpace(_repoUrl)"
                           OnClick="@OpenRepositoryAsync"
                           aria-label="打开 GitHub 仓库" />
        </MudTooltip>

        <MudText Typo="Typo.caption" Class="me-2 mud-text-secondary">
            v@_currentVersion
        </MudText>

        @if (_hasUpdate && !string.IsNullOrWhiteSpace(_latestVersionUrl))
        {
            <MudChip T="string"
                     Size="Size.Small"
                     Color="Color.Warning"
                     Variant="Variant.Outlined"
                     Style="cursor: pointer;"
                     OnClick="@PromptOpenLatestAsync">
                新版本 v@_latestVersion
            </MudChip>
        }

        <AuthorizeView>
            <Authorized>
                <MudMenu Icon="@Icons.Material.Filled.AccountCircle"
                         Color="Color.Inherit"
                         AnchorOrigin="Origin.BottomRight"
                         TransformOrigin="Origin.TopRight">
                    <MudMenuItem>
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Person" Class="me-2" />
                            <MudText>@context.User.Identity?.Name</MudText>
                        </div>
                    </MudMenuItem>
                    <MudDivider />
                    <MudMenuItem Href="/settings" Icon="@Icons.Material.Filled.Settings">设置</MudMenuItem>
                    <MudDivider />
                    <MudMenuItem>
                        <form method="post" action="/api/auth/logout" style="margin: 0;">
                            <AntiforgeryToken />
                            <MudButton ButtonType="ButtonType.Submit"
                                       Variant="Variant.Text"
                                       Color="Color.Error"
                                       StartIcon="@Icons.Material.Filled.Logout"
                                       FullWidth="true">
                                退出登录
                            </MudButton>
                        </form>
                    </MudMenuItem>
                </MudMenu>
            </Authorized>
            <NotAuthorized>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Href="/login"
                           StartIcon="@Icons.Material.Filled.Login">
                    登录
                </MudButton>
            </NotAuthorized>
        </AuthorizeView>
    </MudAppBar>

    @* 侧边栏 - 280px 宽度 *@
    <MudDrawer @bind-Open="_drawerOpen"
               Elevation="1"
               Variant="DrawerVariant.Responsive"
               ClipMode="DrawerClipMode.Always"
               Width="280px"
               Class="teledeck-drawer">
        <div class="d-flex flex-column" style="height: 100%;">
            <NavMenu />

            @* 底部系统状态仪表盘 *@
            <MudSpacer />
            <div class="teledeck-system-status pa-3">
                <MudDivider Class="mb-3" />
                <div class="d-flex align-center justify-space-between mb-2">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">系统状态</MudText>
                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Outlined">
                        运行中
                    </MudChip>
                </div>
                <div class="d-flex align-center mb-1">
                    <MudIcon Icon="@Icons.Material.Filled.Memory" Size="Size.Small" Class="me-2" Color="Color.Secondary" />
                    <MudText Typo="Typo.body2" Color="Color.Secondary">活跃实例</MudText>
                    <MudSpacer />
                    <MudText Typo="Typo.body2" Color="Color.Primary">@_activeInstances / @_maxInstances</MudText>
                </div>
                <MudProgressLinear Value="@(_activeInstances * 100.0 / Math.Max(_maxInstances, 1))"
                                   Color="Color.Primary"
                                   Size="Size.Small"
                                   Rounded="true"
                                   Class="mt-2" />
            </div>
        </div>
    </MudDrawer>

    @* 主内容区域 *@
    <MudMainContent Class="teledeck-main-content">
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    private int _activeInstances = 0;
    private int _maxInstances = 50;

    private const string ThemeStorageKey = "teledeck-theme";
    private bool _isDarkMode = true;
    private bool _securityPromptShown;

    private string _currentVersion = "1.5.2";
    private string? _latestVersion;
    private bool _hasUpdate;
    private string? _repoUrl;
    private string? _latestVersionUrl;

    /// <summary>
    /// Telegram 官方配色主题 (Material Design 3 + 沉浸式深色模式)
    /// </summary>
    private readonly MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight
        {
            Primary = "#2AABEE",
            PrimaryDarken = "#2B5278",
            PrimaryLighten = "#3DB8F5",

            Background = "#F6F7F9",
            Surface = "#FFFFFF",

            Success = "#00C853",
            Error = "#FF5252",
            Warning = "#FFB300",
            Info = "#2AABEE",

            TextPrimary = "#111827",
            TextSecondary = "#4B5563",           // 优化：从 #6B7280 调深至 #4B5563 (对比度 7.0:1)

            AppbarBackground = "#FFFFFF",
            DrawerBackground = "#FFFFFF",

            ActionDefault = "#374151",
            ActionDisabled = "#6B7280",          // 优化：从 #9CA3AF 调深至 #6B7280 (对比度 4.6:1)
            Divider = "#E5E7EB",
            LinesDefault = "#E5E7EB"
        },
        PaletteDark = new PaletteDark
        {
            // 核心配色 - 基于 Telegram 官方蓝
            Primary = "#2AABEE",           // Telegram Blue - 按钮、进度条、强调色
            PrimaryDarken = "#2B5278",     // 发送消息气泡背景
            PrimaryLighten = "#3DB8F5",    // 悬停状态

            // 背景色系
            Background = "#121212",         // 页面底层背景
            Surface = "#1E1E1E",           // 卡片、侧边栏、对话框背景

            // 状态色
            Success = "#00E676",           // 优化：从 #00C853 调亮至 #00E676 (对比度 5.8:1)
            Error = "#FF5252",             // 账号掉线、操作失败
            Warning = "#FFB300",           // 警告状态
            Info = "#2AABEE",              // 信息提示

            // 文字色
            TextPrimary = "#E0E0E0",       // 主要文字内容
            TextSecondary = "#B0B0B0",     // 优化：从 #9E9E9E 调亮至 #B0B0B0 (对比度 11.2:1)

            // 组件背景
            AppbarBackground = "#121212",
            DrawerBackground = "#1E1E1E",

            // 其他
            ActionDefault = "#9E9E9E",
            ActionDisabled = "#757575",    // 优化：从 #616161 调亮至 #757575 (对比度 5.2:1)
            Divider = "#424242",
            LinesDefault = "#424242"
        },

        // 排版配置
        Typography = new Typography
        {
            Default = new Default
            {
                FontFamily = new[] { "Inter", "-apple-system", "BlinkMacSystemFont", "Segoe UI", "Roboto", "Helvetica Neue", "Arial", "sans-serif" }
            }
        }
    };

    private void ToggleDrawer() => _drawerOpen = !_drawerOpen;

    protected override void OnInitialized()
    {
        AppUpdate.Changed += OnUpdateStateChanged;
        RefreshUpdateState();

        // 这里可以获取实际的活跃实例数
        // _activeInstances = TdClientManager.ActiveCount;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        try
        {
            var v = await Js.InvokeAsync<string?>("localStorage.getItem", ThemeStorageKey);
            if (string.Equals(v, "light", StringComparison.OrdinalIgnoreCase))
                _isDarkMode = false;
            else if (string.Equals(v, "dark", StringComparison.OrdinalIgnoreCase))
                _isDarkMode = true;
        }
        catch
        {
            // 忽略：不支持 localStorage 或被浏览器策略禁用时，保持默认主题
        }

        await PromptChangeDefaultCredentialsIfNeededAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task PromptChangeDefaultCredentialsIfNeededAsync()
    {
        if (_securityPromptShown)
            return;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated != true)
            return;

        var raw = await AppConfigService.GetStringAsync(AppConfigKeys.SecurityMustChangeAdminCredentials, CancellationToken.None);
        var mustChange = bool.TryParse(raw, out var b) && b;
        if (!mustChange)
            return;

        _securityPromptShown = true;

        var ok = await DialogService.ShowMessageBox(
            "安全提醒",
            "检测到你仍在使用默认/弱密码。为保障安全，请立即在“账号安全”中修改用户名和密码。",
            yesText: "去修改",
            cancelText: "稍后再说");

        if (ok == true)
            Navigation.NavigateTo("/security");
    }

    private async Task ToggleThemeAsync()
    {
        _isDarkMode = !_isDarkMode;

        try
        {
            await Js.InvokeVoidAsync("localStorage.setItem", ThemeStorageKey, _isDarkMode ? "dark" : "light");
        }
        catch
        {
            // 忽略：不支持 localStorage 或被浏览器策略禁用时，不做持久化
        }

        Snackbar.Add(_isDarkMode ? "已切换到深色模式" : "已切换到浅色模式", Severity.Info);
    }

    private void ShowSearchNotReady()
    {
        Snackbar.Add("全局搜索功能正在开发中", Severity.Info);
    }

    private void OnUpdateStateChanged()
    {
        InvokeAsync(() =>
        {
            try
            {
                RefreshUpdateState();
                StateHasChanged();
            }
            catch (Exception ex)
            {
                // 记录错误
                Console.Error.WriteLine($"UI更新失败: {ex}");
            }
        });
    }

    private void RefreshUpdateState()
    {
        _currentVersion = AppUpdate.CurrentVersion;
        _latestVersion = AppUpdate.LatestVersion;
        _hasUpdate = AppUpdate.IsUpdateAvailable;
        _repoUrl = AppUpdate.RepositoryUrl;
        _latestVersionUrl = AppUpdate.LatestVersionUrl;
    }

    private async Task OpenRepositoryAsync()
    {
        if (string.IsNullOrWhiteSpace(_repoUrl))
            return;

        await OpenUrlNewTabAsync(_repoUrl);
    }

    private async Task PromptOpenLatestAsync()
    {
        if (string.IsNullOrWhiteSpace(_latestVersionUrl))
            return;

        var ok = await DialogService.ShowMessageBox(
            "发现新版本",
            $"发现新版本 v{_latestVersion}，是否跳转到 GitHub 查看？",
            yesText: "打开 GitHub",
            cancelText: "取消");

        if (ok == true)
            await OpenUrlNewTabAsync(_latestVersionUrl);
    }

    private async Task OpenUrlNewTabAsync(string url)
    {
        try
        {
            await Js.InvokeVoidAsync("open", url, "_blank", "noopener,noreferrer");
        }
        catch
        {
            Navigation.NavigateTo(url, forceLoad: true);
        }
    }

    public void Dispose()
    {
        AppUpdate.Changed -= OnUpdateStateChanged;
    }
}
