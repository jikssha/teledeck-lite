@page "/settings"
@attribute [Authorize(Roles = Roles.Admin)]

@inject IAppConfigService AppConfigService

<PageTitle>系统设置</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium">
    <MudText Typo="Typo.h5">系统设置</MudText>

    <MudPaper Class="pa-4 mt-4" Elevation="1">
        <MudText Typo="Typo.subtitle1">Telegram API 配置</MudText>

        @if (!string.IsNullOrWhiteSpace(_message))
        {
            <MudAlert Severity="@_messageSeverity" Class="mt-3">@_message</MudAlert>
        }

        <MudStack Spacing="2" Class="mt-3">
            <MudNumericField T="int" @bind-Value="_apiId" Label="API ID" Variant="Variant.Outlined" Required="true" />
            <MudTextField @bind-Value="_apiHash" Label="API Hash" Variant="Variant.Outlined" Required="true" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveAsync">保存</MudButton>
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private int _apiId;
    private string _apiHash = string.Empty;

    private string? _message;
    private Severity _messageSeverity = Severity.Info;

    protected override async Task OnInitializedAsync()
    {
        var cfg = await AppConfigService.GetTelegramApiConfigAsync(CancellationToken.None);
        if (cfg is not null)
        {
            _apiId = cfg.ApiId;
            _apiHash = cfg.ApiHash;
        }
    }

    private async Task SaveAsync()
    {
        try
        {
            await AppConfigService.SetTelegramApiConfigAsync(new TelegramApiConfigDto(_apiId, _apiHash), CancellationToken.None);
            _message = "保存成功（无需重启，下一次连接时生效）";
            _messageSeverity = Severity.Success;
        }
        catch (Exception ex)
        {
            _message = ex.Message;
            _messageSeverity = Severity.Error;
        }
    }
}
