@page "/settings"
@attribute [Authorize(Roles = Roles.Admin)]

@inject IAppConfigService AppConfigService
@inject NavigationManager NavigationManager

<PageTitle>系统设置</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge">
    <MudText Typo="Typo.h5" Class="mb-4">系统设置</MudText>

    <MudTabs Elevation="1" Rounded="true" Color="Color.Primary">
        <MudTabPanel Text="API 配置" Icon="@Icons.Material.Filled.Api">
            <MudPaper Class="pa-4 mt-4" Elevation="0">
                <MudText Typo="Typo.subtitle1" Class="mb-3">Telegram API 配置</MudText>

                @if (!string.IsNullOrWhiteSpace(_message))
                {
                    <MudAlert Severity="@_messageSeverity" Class="mb-3">@_message</MudAlert>
                }

                <MudStack Spacing="2">
                    <MudNumericField T="int" @bind-Value="_apiId" Label="API ID" Variant="Variant.Outlined" Required="true" />
                    <MudTextField @bind-Value="_apiHash" Label="API Hash" Variant="Variant.Outlined" Required="true" />
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveAsync">保存</MudButton>
                </MudStack>
            </MudPaper>
        </MudTabPanel>

        <MudTabPanel Text="审计日志" Icon="@Icons.Material.Filled.History">
            <MudPaper Class="pa-0 mt-4" Elevation="0">
                <AuditLogViewer />
            </MudPaper>
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@code {
    private int _apiId;
    private string _apiHash = string.Empty;

    private string? _message;
    private Severity _messageSeverity = Severity.Info;

    protected override async Task OnInitializedAsync()
    {
        var cfg = await AppConfigService.GetTelegramApiConfigAsync(CancellationToken.None);
        if (cfg is not null)
        {
            _apiId = cfg.ApiId;
            _apiHash = cfg.ApiHash;
        }
    }

    private async Task SaveAsync()
    {
        try
        {
            await AppConfigService.SetTelegramApiConfigAsync(new TelegramApiConfigDto(_apiId, _apiHash), CancellationToken.None);
            _message = "保存成功（无需重启，下一次连接时生效）";
            _messageSeverity = Severity.Success;
        }
        catch (Exception ex)
        {
            _message = ex.Message;
            _messageSeverity = Severity.Error;
        }
    }
}
